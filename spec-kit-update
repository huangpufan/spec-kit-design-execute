#!/usr/bin/env bash
# Spec-Lite Update Script
#
# This script updates the sk-init command and reinitializes the current project if needed.
#
# Usage:
#   sk-update
#

set -e

# --- Source Common Functions ---
# Find the real directory of the script to source the common functions
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SPEC_KIT_ROOT="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
source "$SPEC_KIT_ROOT/common-install.sh"

print_header "${EMOJI_LOOP} Updating Spec-Lite"


# 检查当前目录是否已经执行过 sk-init
is_spec_lite_initialized() {
    # 检查是否在 git 仓库中
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        return 1
    fi
    
    local project_root=$(git rev-parse --show-toplevel)
    
    # 检查必要的目录和文件是否存在
    if [[ -d "$project_root/.cursor/commands" ]] && 
       [[ -f "$project_root/.cursor/commands/design.md" ]] && 
       [[ -f "$project_root/.cursor/commands/execute.md" ]] && 
       [[ -f "$project_root/.cursor/commands/read.md" ]]; then
        return 0
    else
        return 1
    fi
}

# --- Main Update Logic ---
print_step "Checking current project status"
SHOULD_REINIT=false
if is_spec_lite_initialized; then
    SHOULD_REINIT=true
    log_info "Current project is initialized. It will be re-initialized after the update."
else
    log_info "Current project is not initialized. Skipping re-initialization."
fi


# 执行卸载和重新安装
print_step "Updating core components"
log_info "Uninstalling the old version..."
if curl -sSL https://raw.githubusercontent.com/huangpufan/spec-lite/master/uninstall.sh | bash; then
    log_success "Old version uninstalled."
else
    log_error "Uninstallation failed."
    exit 1
fi

log_info "Installing the new version..."
if curl -sSL https://raw.githubusercontent.com/huangpufan/spec-lite/master/install.sh | bash; then
    log_success "New version installed."
else
    log_error "Installation failed."
    exit 1
fi

# 如果之前已经初始化，则重新初始化
if [[ "$SHOULD_REINIT" == "true" ]]; then
    print_step "Re-initializing project"
    if command -v sk-init >/dev/null 2>&1; then
        sk-init
    else
        log_error "sk-init command is not available. Please check the installation."
        exit 1
    fi
fi

print_header "${EMOJI_SPARKLE} Update Complete"
log_success "Spec-Lite has been updated successfully!"
echo ""

if [[ "$SHOULD_REINIT" == "true" ]]; then
    log_info "The project has been re-initialized. You can continue using the commands:"
    print_command "/design <description> - Create an interactive design document"
    print_command "/execute              - Execute the approved design"
    print_command "/read <query>         - Deeply analyze and understand the existing codebase"
else
    log_info "To use Spec-Lite commands in a project, navigate to its directory and run:"
    print_command "sk-init"
fi
echo ""
