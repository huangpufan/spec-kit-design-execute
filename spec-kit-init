#!/usr/bin/env bash
# 快速设置新命令到现有项目的脚本

set -e

# Find the real directory of the script, resolving symlinks
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, resolve it relative to the symlink's path
done
SPEC_KIT_ROOT="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# 检查是否在 git 仓库中
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "错误：请在一个 git 仓库中运行此脚本"
    exit 1
fi

PROJECT_ROOT=$(git rev-parse --show-toplevel)

# 检查是否已有语言配置
LANG_CONFIG="$PROJECT_ROOT/.specify/config/language.conf"
if [ -f "$LANG_CONFIG" ]; then
    # 如果已有配置，读取并显示
    source "$LANG_CONFIG"
    echo "检测到已有语言配置: $([ "$LANGUAGE" = "zh" ] && echo "中文" || echo "English")"
    echo "是否要更改语言设置? / Do you want to change the language setting? (y/N)"
    read -r CHANGE_LANG
    if [[ ! "$CHANGE_LANG" =~ ^[Yy]$ ]]; then
        echo "保持当前语言设置 / Keeping current language setting"
    else
        # 重新选择语言
        echo ""
        echo "请选择文档语言 / Please select document language:"
        PS3="请输入选项编号 / Please enter your choice: "
        options=("中文 (Chinese)" "English")
        select opt in "${options[@]}"
        do
            case $opt in
                "中文 (Chinese)")
                    LANGUAGE="zh"
                    echo "您选择了中文文档"
                    break
                    ;;
                "English")
                    LANGUAGE="en"
                    echo "You selected English documentation"
                    break
                    ;;
                *) echo "无效选项，请重新选择 / Invalid option, please try again";;
            esac
        done
    fi
else
    # 没有配置文件，进行首次选择
    echo "请选择文档语言 / Please select document language:"
    PS3="请输入选项编号 / Please enter your choice: "
    options=("中文 (Chinese)" "English")
    select opt in "${options[@]}"
    do
        case $opt in
            "中文 (Chinese)")
                LANGUAGE="zh"
                echo "您选择了中文文档"
                break
                ;;
            "English")
                LANGUAGE="en"
                echo "You selected English documentation"
                break
                ;;
            *) echo "无效选项，请重新选择 / Invalid option, please try again";;
        esac
    done
fi

echo ""
echo "设置新的 design 和 execute 命令..."

# 创建必要的目录
mkdir -p "$PROJECT_ROOT/.cursor/commands"
mkdir -p "$PROJECT_ROOT/.specify/scripts/bash"
mkdir -p "$PROJECT_ROOT/.specify/scripts/powershell"
mkdir -p "$PROJECT_ROOT/.specify/config"

# 保存语言配置
echo "LANGUAGE=$LANGUAGE" > "$PROJECT_ROOT/.specify/config/language.conf"

# 复制命令文件
echo "复制命令文件..."
cp "$SPEC_KIT_ROOT/templates/commands/design.md" "$PROJECT_ROOT/.cursor/commands/"
cp "$SPEC_KIT_ROOT/templates/commands/execute.md" "$PROJECT_ROOT/.cursor/commands/"
cp "$SPEC_KIT_ROOT/templates/commands/read.md" "$PROJECT_ROOT/.cursor/commands/"

# 复制脚本文件
echo "复制脚本文件..."
cp "$SPEC_KIT_ROOT/scripts/bash/design-alignment.sh" "$PROJECT_ROOT/.specify/scripts/bash/"
cp "$SPEC_KIT_ROOT/scripts/bash/execute-design.sh" "$PROJECT_ROOT/.specify/scripts/bash/"
cp "$SPEC_KIT_ROOT/scripts/powershell/design-alignment.ps1" "$PROJECT_ROOT/.specify/scripts/powershell/"
cp "$SPEC_KIT_ROOT/scripts/powershell/execute-design.ps1" "$PROJECT_ROOT/.specify/scripts/powershell/"

# 设置执行权限
chmod +x "$PROJECT_ROOT/.specify/scripts/bash/"*.sh

echo "✅ 新命令已成功设置！"
echo ""
echo "现在你可以在 Cursor 中使用："
echo "  /design <需求描述> - 创建交互式设计文档"
echo "  /execute - 执行已批准的设计"
echo "  /read <查询> - 深度分析和理解现有代码库"
echo ""
echo "提示：第一次使用时，Cursor 可能需要重新加载项目才能识别新命令。"
